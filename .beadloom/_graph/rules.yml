version: 3

tags:
  layer-service: [cli, mcp-server, tui]
  layer-domain: [context-oracle, doc-sync, graph, onboarding]
  layer-infra: [infrastructure]

rules:
  - name: domain-needs-parent
    description: "Every domain must be part_of the beadloom service"
    require:
      for: { kind: domain }
      has_edge_to: { ref_id: beadloom }
      edge_kind: part_of

  - name: feature-needs-domain
    description: "Every feature must be part_of a domain"
    require:
      for: { kind: feature }
      has_edge_to: { kind: domain }
      edge_kind: part_of

  - name: service-needs-parent
    description: "Every service (except root) must be part_of the beadloom service"
    require:
      for: { kind: service, exclude: [beadloom] }
      has_edge_to: { ref_id: beadloom }
      edge_kind: part_of

  - name: no-domain-depends-on-service
    description: "Domains must not have depends_on edges to services"
    deny:
      from: { kind: domain }
      to: { kind: service }
      unless_edge: [part_of]

  - name: no-dependency-cycles
    description: "No circular depends_on chains"
    severity: warn
    forbid_cycles:
      edge_kind: depends_on

  - name: architecture-layers
    description: "Services use domains, domains use infrastructure â€” not reverse"
    severity: warn
    layers:
      - name: services
        tag: layer-service
      - name: domains
        tag: layer-domain
      - name: infrastructure
        tag: layer-infra
    enforce: top-down
    allow_skip: true
    edge_kind: depends_on

  - name: domain-size-limit
    description: "Domains should not have too many symbols"
    severity: warn
    check:
      for: { kind: domain }
      max_symbols: 200

  - name: tui-no-direct-infra
    description: "TUI must not import infrastructure directly"
    forbid_import:
      from: "src/beadloom/tui/**"
      to: "src/beadloom/infrastructure/**"

  - name: onboarding-no-direct-infra
    description: "Onboarding must not import infrastructure directly"
    forbid_import:
      from: "src/beadloom/onboarding/**"
      to: "src/beadloom/infrastructure/**"
